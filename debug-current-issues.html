<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ› Debug - Problemas OP e Portal</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .section { 
            border: 1px solid #ddd; 
            margin: 20px 0; 
            padding: 15px; 
            border-radius: 8px;
        }
        .button-group { margin: 20px 0; }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ› Debug - Problemas Identificados</h1>
        
        <div class="section">
            <h2>ğŸ“‹ Problema 1: CriaÃ§Ã£o de OPs</h2>
            <p><strong>Sintoma:</strong> OP criada mas nÃ£o aparece na lista</p>
            <button onclick="debugOrderCreation()">ğŸ” Debug CriaÃ§Ã£o OPs</button>
            <button onclick="testCreateOrder()">ğŸ§ª Teste Criar OP</button>
            <button onclick="listOrders()">ğŸ“‹ Listar OPs</button>
        </div>

        <div class="section">
            <h2>ğŸ‘¤ Problema 2: Portal do Operador</h2>
            <p><strong>Sintoma:</strong> Erro ao entrar em qualquer mÃ¡quina</p>
            <button onclick="debugOperatorPortal()">ğŸ” Debug Portal</button>
            <button onclick="checkOperatorMethods()">âš™ï¸ Verificar MÃ©todos</button>
            <button onclick="testOperatorSession()">ğŸ§ª Teste SessÃ£o</button>
        </div>

        <div class="section">
            <h2>ğŸ”§ CorreÃ§Ãµes AutomÃ¡ticas</h2>
            <button onclick="fixAllIssues()">ğŸš€ Corrigir Todos os Problemas</button>
            <button onclick="resetSystem()">ğŸ”„ Resetar Sistema</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const results = document.getElementById('results');

        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        async function debugOrderCreation() {
            addLog('ğŸ” Debugando criaÃ§Ã£o de OPs...', 'info');
            
            try {
                // Check if createProductionOrder method exists
                if (window.productionService && window.productionService.createProductionOrder) {
                    addLog('âœ… MÃ©todo createProductionOrder existe', 'success');
                } else {
                    addLog('âŒ MÃ©todo createProductionOrder nÃ£o encontrado', 'error');
                    return;
                }

                // Check storage
                const stored = localStorage.getItem('factoryControl_production');
                if (stored) {
                    const data = JSON.parse(stored);
                    addLog(`ğŸ“Š ${data.productionOrders?.length || 0} OPs no storage`, 'info');
                    
                    if (data.productionOrders && data.productionOrders.length > 0) {
                        addLog('ğŸ“‹ OPs encontradas:', 'info');
                        data.productionOrders.forEach((order, idx) => {
                            addLog(`  ${idx + 1}. ${order.orderNumber} - ${order.status}`, 'info');
                        });
                    }
                } else {
                    addLog('âš ï¸ Nenhum dado no storage', 'warning');
                }

            } catch (error) {
                addLog(`âŒ Erro no debug: ${error.message}`, 'error');
            }
        }

        async function testCreateOrder() {
            addLog('ğŸ§ª Testando criaÃ§Ã£o de OP...', 'info');
            
            try {
                if (!window.productionService) {
                    addLog('âŒ productionService nÃ£o disponÃ­vel', 'error');
                    return;
                }

                const testOrder = {
                    orderNumber: `OP-TEST-${Date.now()}`,
                    customer: {
                        id: 'test-customer',
                        name: 'Cliente Teste',
                        contact: 'teste@exemplo.com'
                    },
                    expectedDeliveryDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                    lines: [],
                    status: 'created',
                    priority: 'medium',
                    totalVolume: 0,
                    estimatedCost: 0,
                    notes: 'OP de teste para debug',
                    createdBy: 'Debug'
                };

                const created = await window.productionService.createProductionOrder(testOrder);
                addLog(`âœ… OP criada: ${created.orderNumber}`, 'success');
                
                // Verify it was saved
                setTimeout(() => listOrders(), 500);

            } catch (error) {
                addLog(`âŒ Erro ao criar OP: ${error.message}`, 'error');
            }
        }

        async function listOrders() {
            addLog('ğŸ“‹ Listando OPs...', 'info');
            
            try {
                if (!window.productionService) {
                    addLog('âŒ productionService nÃ£o disponÃ­vel', 'error');
                    return;
                }

                const orders = await window.productionService.getProductionOrders();
                addLog(`ğŸ“Š Total de OPs: ${orders.length}`, 'info');
                
                if (orders.length === 0) {
                    addLog('âš ï¸ Nenhuma OP encontrada', 'warning');
                } else {
                    orders.forEach((order, idx) => {
                        addLog(`  ${idx + 1}. ${order.orderNumber} - ${order.status} - ${order.customer.name}`, 'info');
                    });
                }

            } catch (error) {
                addLog(`âŒ Erro ao listar OPs: ${error.message}`, 'error');
            }
        }

        async function debugOperatorPortal() {
            addLog('ğŸ” Debugando portal do operador...', 'info');
            
            try {
                // Check methods needed for operator portal
                const requiredMethods = [
                    'startOperatorSession',
                    'endOperatorSession', 
                    'getOperatorSessions',
                    'getOperatorWorkItems',
                    'getChatMessages'
                ];

                let missingMethods = [];
                
                requiredMethods.forEach(method => {
                    if (window.productionService && typeof window.productionService[method] === 'function') {
                        addLog(`âœ… MÃ©todo ${method} existe`, 'success');
                    } else {
                        addLog(`âŒ MÃ©todo ${method} nÃ£o encontrado`, 'error');
                        missingMethods.push(method);
                    }
                });

                if (missingMethods.length === 0) {
                    addLog('âœ… Todos os mÃ©todos necessÃ¡rios estÃ£o presentes', 'success');
                } else {
                    addLog(`âŒ ${missingMethods.length} mÃ©todos em falta: ${missingMethods.join(', ')}`, 'error');
                }

            } catch (error) {
                addLog(`âŒ Erro no debug: ${error.message}`, 'error');
            }
        }

        async function checkOperatorMethods() {
            addLog('âš™ï¸ Verificando mÃ©todos do operador...', 'info');
            
            try {
                if (!window.productionService) {
                    addLog('âŒ productionService nÃ£o disponÃ­vel', 'error');
                    return;
                }

                // Check if machines are available
                const machines = await window.productionService.getMachines();
                addLog(`ğŸ­ ${machines.length} mÃ¡quinas disponÃ­veis`, 'info');

                // Check if we can get work items
                const workItems = await window.productionService.getOperatorWorkItems();
                addLog(`ğŸ“‹ ${workItems.length} work items encontrados`, 'info');

                // Check sessions
                const sessions = await window.productionService.getOperatorSessions();
                addLog(`ğŸ‘¤ ${sessions.length} sessÃµes no histÃ³rico`, 'info');

            } catch (error) {
                addLog(`âŒ Erro ao verificar mÃ©todos: ${error.message}`, 'error');
            }
        }

        async function testOperatorSession() {
            addLog('ğŸ§ª Testando sessÃ£o do operador...', 'info');
            
            try {
                if (!window.productionService) {
                    addLog('âŒ productionService nÃ£o disponÃ­vel', 'error');
                    return;
                }

                // Get first available machine
                const machines = await window.productionService.getMachines();
                if (machines.length === 0) {
                    addLog('âŒ Nenhuma mÃ¡quina disponÃ­vel', 'error');
                    return;
                }

                const machine = machines[0];
                addLog(`ğŸ­ Testando com mÃ¡quina: ${machine.name}`, 'info');

                // Try to start a session
                const session = await window.productionService.startOperatorSession(
                    'test-operator',
                    'Operador Teste',
                    machine.id
                );

                addLog(`âœ… SessÃ£o criada: ${session.id}`, 'success');

                // End the session
                await window.productionService.endOperatorSession(session.id);
                addLog('âœ… SessÃ£o encerrada com sucesso', 'success');

            } catch (error) {
                addLog(`âŒ Erro no teste de sessÃ£o: ${error.message}`, 'error');
            }
        }

        async function fixAllIssues() {
            addLog('ğŸš€ Corrigindo todos os problemas...', 'info');
            
            try {
                // Clear and reinitialize
                if (window.initializeCleanSystem) {
                    await window.initializeCleanSystem();
                    addLog('âœ… Sistema reinicializado', 'success');
                }

                // Test both functionalities
                await testCreateOrder();
                await testOperatorSession();

                addLog('ğŸ‰ CorreÃ§Ãµes aplicadas! Recarregue a pÃ¡gina principal.', 'success');

            } catch (error) {
                addLog(`âŒ Erro na correÃ§Ã£o: ${error.message}`, 'error');
            }
        }

        async function resetSystem() {
            addLog('ğŸ”„ Resetando sistema...', 'info');
            
            if (window.clearProductionData) {
                await window.clearProductionData();
                addLog('âœ… Sistema resetado', 'success');
            } else {
                // Manual reset
                localStorage.clear();
                addLog('âœ… localStorage limpo manualmente', 'success');
            }
            
            addLog('ğŸ”„ Recarregue a pÃ¡gina para aplicar', 'warning');
        }

        // Auto-run basic checks
        window.addEventListener('load', () => {
            addLog('ğŸ› Debug dos problemas iniciado', 'info');
            setTimeout(() => {
                debugOrderCreation();
                debugOperatorPortal();
            }, 1000);
        });
    </script>
</body>
</html>
