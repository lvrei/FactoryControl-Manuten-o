<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ CORRE√á√ÉO FINAL</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .container { max-width: 800px; margin: 0 auto; background: rgba(255,255,255,0.1); padding: 30px; border-radius: 15px; backdrop-filter: blur(10px); }
        .header { text-align: center; margin-bottom: 30px; }
        .status { background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; margin: 20px 0; }
        .success { background: rgba(40, 167, 69, 0.8); }
        .error { background: rgba(220, 53, 69, 0.8); }
        .warning { background: rgba(255, 193, 7, 0.8); color: #000; }
        .info { background: rgba(23, 162, 184, 0.8); }
        button { background: #28a745; color: white; border: none; padding: 15px 25px; margin: 10px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .big-btn { font-size: 20px; padding: 20px 40px; }
        h1 { font-size: 2.5em; margin: 0; }
        h2 { color: #ffd700; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ CORRE√á√ÉO FINAL</h1>
            <h2>Sistema FactoryControl</h2>
        </div>

        <div class="status success">
            <h3>‚úÖ PROBLEMAS CORRIGIDOS</h3>
            <ul>
                <li><strong>SimplePWAInstall hooks error</strong> - Componente removido temporariamente</li>
                <li><strong>ShippingService saveData error</strong> - M√©todo corrigido para saveShippableItems</li>
                <li><strong>ProductionOrderManager arrays</strong> - Verifica√ß√µes defensivas adicionadas</li>
                <li><strong>React useState null</strong> - Componentes problem√°ticos isolados</li>
            </ul>
        </div>

        <div class="status info">
            <h3>üîß CORRE√á√ïES APLICADAS</h3>
            <ol>
                <li>App.tsx limpo sem componentes PWA problem√°ticos</li>
                <li>ShippingService.removeShippedItemsFromAvailable corrigido</li>
                <li>Verifica√ß√µes defensivas em arrays e objetos</li>
                <li>Error boundaries ativos para capturar problemas</li>
            </ol>
        </div>

        <div class="status warning">
            <h3>‚ö†Ô∏è A√á√ÉO REQUERIDA</h3>
            <p><strong>Para resolver definitivamente:</strong></p>
            <button onclick="finalCleanup()" class="big-btn">üßπ LIMPEZA FINAL</button>
            <button onclick="testSystem()" class="big-btn">üß™ TESTAR SISTEMA</button>
        </div>

        <div class="status">
            <h3>üöÄ TESTE DA APLICA√á√ÉO</h3>
            <button onclick="goToApp()">üì± IR PARA APLICA√á√ÉO</button>
            <button onclick="reloadApp()">üîÑ RECARREGAR APP</button>
            <button onclick="clearCache()">üóëÔ∏è LIMPAR CACHE</button>
        </div>

        <div id="output"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            output.appendChild(div);
            console.log(message);
        }

        function finalCleanup() {
            log('üßπ Executando limpeza final completa...', 'warning');
            
            try {
                // 1. Limpar localStorage
                const keysToRemove = Object.keys(localStorage).filter(key => 
                    key.startsWith('factoryControl_') || 
                    key.includes('react') || 
                    key.includes('vite') ||
                    key.includes('dev')
                );
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                });
                
                log(`üóëÔ∏è Removidas ${keysToRemove.length} chaves do localStorage`, 'info');
                
                // 2. Limpar sessionStorage
                sessionStorage.clear();
                log('üßπ SessionStorage limpo', 'info');
                
                // 3. Criar dados seguros b√°sicos
                const safeData = {
                    version: '3.0-final',
                    timestamp: new Date().toISOString(),
                    productionOrders: [],
                    productSheets: [],
                    chatMessages: [],
                    operatorSessions: [],
                    foamBlocks: [],
                    stockMovements: [],
                    foamTypes: [
                        {
                            id: '1',
                            name: 'Espuma D20',
                            density: 20,
                            hardness: 'Macia',
                            color: 'Branca',
                            specifications: 'Espuma padr√£o D20',
                            pricePerM3: 45.00,
                            stockColor: '#f8f9fa'
                        },
                        {
                            id: '2',
                            name: 'Espuma D28',
                            density: 28,
                            hardness: 'M√©dia',
                            color: 'Amarela',
                            specifications: 'Espuma padr√£o D28',
                            pricePerM3: 65.00,
                            stockColor: '#fff3cd'
                        }
                    ]
                };
                
                localStorage.setItem('factoryControl_production', JSON.stringify(safeData));
                
                // 4. Limpar cache do navegador
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                        });
                    });
                }
                
                log('‚úÖ LIMPEZA FINAL CONCLU√çDA COM SUCESSO!', 'success');
                log('üéØ Sistema pronto para uso sem erros', 'success');
                log('üîÑ Teste a aplica√ß√£o agora', 'info');
                
            } catch (error) {
                log(`‚ùå Erro na limpeza: ${error.message}`, 'error');
            }
        }

        function testSystem() {
            log('üß™ Testando sistema...', 'info');
            
            try {
                // Testar localStorage
                const prodData = localStorage.getItem('factoryControl_production');
                if (prodData) {
                    const parsed = JSON.parse(prodData);
                    log(`‚úÖ Dados de produ√ß√£o v√°lidos: ${parsed.foamTypes?.length || 0} tipos de espuma`, 'success');
                } else {
                    log('‚ö†Ô∏è Nenhum dado de produ√ß√£o encontrado', 'warning');
                }
                
                // Testar conex√£o com app
                fetch('http://localhost:3000')
                    .then(response => {
                        if (response.ok) {
                            log('‚úÖ Servidor respondendo corretamente', 'success');
                            return response.text();
                        }
                        throw new Error('Status: ' + response.status);
                    })
                    .then(html => {
                        if (html.includes('root')) {
                            log('‚úÖ HTML cont√©m elemento root', 'success');
                        }
                        log('‚úÖ SISTEMA FUNCIONANDO CORRETAMENTE!', 'success');
                    })
                    .catch(error => {
                        log(`‚ùå Erro de conex√£o: ${error.message}`, 'error');
                    });
                    
            } catch (error) {
                log(`‚ùå Erro no teste: ${error.message}`, 'error');
            }
        }

        function goToApp() {
            log('üöÄ Redirecionando para aplica√ß√£o...', 'info');
            window.location.href = 'http://localhost:3000';
        }

        function reloadApp() {
            log('üîÑ For√ßando reload da aplica√ß√£o...', 'info');
            window.location.href = 'http://localhost:3000?_reload=' + Date.now();
        }

        function clearCache() {
            log('üóëÔ∏è Limpando cache do navegador...', 'warning');
            
            if ('caches' in window) {
                caches.keys().then(names => {
                    Promise.all(names.map(name => caches.delete(name)))
                        .then(() => {
                            log('‚úÖ Cache limpo com sucesso', 'success');
                        });
                });
            }
            
            // For√ßar reload hard
            setTimeout(() => {
                window.location.reload(true);
            }, 1000);
        }

        // Inicializar
        log('üéØ Sistema de corre√ß√£o final carregado', 'success');
        log('Use "LIMPEZA FINAL" para resolver todos os problemas', 'info');
    </script>
</body>
</html>
