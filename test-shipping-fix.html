<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Shipping Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border-left: 5px solid #28a745; }
        .error { background: #f8d7da; border-left: 5px solid #dc3545; }
        .info { background: #d1ecf1; border-left: 5px solid #17a2b8; }
        .warning { background: #fff3cd; border-left: 5px solid #ffc107; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>ğŸšš Teste de CorreÃ§Ã£o do Sistema de ExpediÃ§Ã£o</h1>
    
    <div class="section">
        <h2>ğŸ”§ Testes de Funcionalidade</h2>
        <button onclick="testMarkOrderLineAsShipped()">âœ… Testar markOrderLineAsShipped</button>
        <button onclick="testRemoveShippedItems()">ğŸ—‘ï¸ Testar RemoÃ§Ã£o de Itens Shipped</button>
        <button onclick="testShippingFilters()">ğŸ” Testar Filtros</button>
        <button onclick="simulateCompleteWorkflow()">ğŸšš Simular Workflow Completo</button>
    </div>

    <div class="section">
        <h2>ğŸ“Š DiagnÃ³stico de Dados</h2>
        <button onclick="checkShippableItems()">ğŸ“¦ Verificar Itens DisponÃ­veis</button>
        <button onclick="checkCompletedLoads()">ğŸš› Verificar Cargas Completadas</button>
        <button onclick="checkProductionOrders()">ğŸ“‹ Verificar Estado OPs</button>
        <button onclick="clearShippingData()">ğŸ§¹ Limpar Dados Shipping</button>
    </div>
    
    <div id="output"></div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            output.appendChild(div);
            console.log(message);
        }

        async function testMarkOrderLineAsShipped() {
            log('ğŸ§ª Testando funÃ§Ã£o markOrderLineAsShipped...', 'info');
            
            try {
                if (typeof window.productionService === 'object' && 
                    typeof window.productionService.markOrderLineAsShipped === 'function') {
                    
                    log('âœ… FunÃ§Ã£o markOrderLineAsShipped existe no productionService', 'success');
                    
                    // Testar com dados fictÃ­cios
                    await window.productionService.markOrderLineAsShipped('test-order-123', 'test-line-456');
                    log('âœ… FunÃ§Ã£o executou sem erro (mesmo com IDs fictÃ­cios)', 'success');
                } else {
                    log('âŒ FunÃ§Ã£o markOrderLineAsShipped nÃ£o encontrada!', 'error');
                }
            } catch (error) {
                if (error.message.includes('not found')) {
                    log('âš ï¸ Esperado: erro de ordem nÃ£o encontrada (IDs fictÃ­cios)', 'warning');
                } else {
                    log(`âŒ Erro inesperado: ${error.message}`, 'error');
                }
            }
        }

        async function testRemoveShippedItems() {
            log('ğŸ§ª Testando remoÃ§Ã£o de itens shipped...', 'info');
            
            try {
                const shippingService = window.shippingService;
                if (!shippingService) {
                    log('âŒ shippingService nÃ£o disponÃ­vel', 'error');
                    return;
                }

                // Verificar se o mÃ©todo existe
                if (typeof shippingService.removeShippedItemsFromAvailable === 'function') {
                    log('âœ… MÃ©todo removeShippedItemsFromAvailable existe', 'success');
                } else {
                    log('âŒ MÃ©todo removeShippedItemsFromAvailable nÃ£o encontrado', 'error');
                }

                // Testar a exportaÃ§Ã£o CSV melhorada
                if (typeof shippingService.exportShippableItemsToCSV === 'function') {
                    log('âœ… FunÃ§Ã£o de exportaÃ§Ã£o CSV existe e foi melhorada', 'success');
                } else {
                    log('âŒ FunÃ§Ã£o de exportaÃ§Ã£o CSV nÃ£o encontrada', 'error');
                }

            } catch (error) {
                log(`âŒ Erro ao testar: ${error.message}`, 'error');
            }
        }

        async function testShippingFilters() {
            log('ğŸ” Testando filtros de shipping...', 'info');
            
            try {
                const shippingService = window.shippingService;
                if (!shippingService) {
                    log('âŒ shippingService nÃ£o disponÃ­vel', 'error');
                    return;
                }

                // Testar filtros
                const testFilters = {
                    status: 'ready',
                    customer: 'teste',
                    foamType: 'D20'
                };

                const items = await shippingService.getShippableItems(testFilters);
                log(`âœ… Filtros funcionando: ${items.length} itens retornados`, 'success');
                log(`ğŸ“Š Filtros testados: status=${testFilters.status}, customer=${testFilters.customer}`, 'info');

            } catch (error) {
                log(`âŒ Erro ao testar filtros: ${error.message}`, 'error');
            }
        }

        async function simulateCompleteWorkflow() {
            log('ğŸšš Simulando workflow completo de expediÃ§Ã£o...', 'info');
            
            try {
                // 1. Verificar itens disponÃ­veis antes
                const shippingService = window.shippingService;
                if (!shippingService) {
                    log('âŒ shippingService nÃ£o disponÃ­vel', 'error');
                    return;
                }

                const itemsBefore = await shippingService.getShippableItems();
                log(`ğŸ“¦ Itens disponÃ­veis antes: ${itemsBefore.length}`, 'info');

                // 2. Verificar cargas
                const loads = await shippingService.getLoads();
                log(`ğŸš› Cargas no sistema: ${loads.length}`, 'info');

                if (loads.length > 0) {
                    const lastLoad = loads[0];
                    log(`ğŸ“‹ Ãšltima carga: ${lastLoad.loadNumber} (${lastLoad.status})`, 'info');
                    log(`ğŸ“Š Itens na carga: ${lastLoad.items.length}`, 'info');
                    
                    if (lastLoad.status === 'completed') {
                        log('âœ… Encontrada carga completada - verificando se itens foram removidos', 'success');
                        
                        // Verificar se os itens desta carga ainda estÃ£o na lista disponÃ­vel
                        const shippedItemIds = lastLoad.items.map(item => item.shippableItemId);
                        const stillAvailable = itemsBefore.filter(item => shippedItemIds.includes(item.id));
                        
                        if (stillAvailable.length === 0) {
                            log('âœ… CorreÃ§Ã£o funcionando: itens shipped foram removidos da lista', 'success');
                        } else {
                            log(`âŒ Problema: ${stillAvailable.length} itens shipped ainda aparecem como disponÃ­veis`, 'error');
                        }
                    }
                } else {
                    log('âš ï¸ Nenhuma carga encontrada para testar', 'warning');
                }

            } catch (error) {
                log(`âŒ Erro no workflow: ${error.message}`, 'error');
            }
        }

        async function checkShippableItems() {
            log('ğŸ“¦ Verificando itens disponÃ­veis para expediÃ§Ã£o...', 'info');
            
            try {
                const shippingService = window.shippingService;
                if (!shippingService) {
                    log('âŒ shippingService nÃ£o disponÃ­vel', 'error');
                    return;
                }

                const items = await shippingService.getShippableItems();
                log(`ğŸ“Š Total de itens disponÃ­veis: ${items.length}`, 'info');

                if (items.length > 0) {
                    const byCustomer = items.reduce((acc, item) => {
                        acc[item.customerName] = (acc[item.customerName] || 0) + 1;
                        return acc;
                    }, {});

                    log('ğŸ‘¥ Por cliente:', 'info');
                    Object.entries(byCustomer).forEach(([customer, count]) => {
                        log(`   - ${customer}: ${count} itens`, 'info');
                    });

                    const ready = items.filter(item => item.readyForShipping);
                    log(`âœ… Prontos para expediÃ§Ã£o: ${ready.length}`, ready.length > 0 ? 'success' : 'warning');
                } else {
                    log('ğŸ“­ Nenhum item disponÃ­vel para expediÃ§Ã£o', 'warning');
                }

            } catch (error) {
                log(`âŒ Erro ao verificar itens: ${error.message}`, 'error');
            }
        }

        async function checkCompletedLoads() {
            log('ğŸš› Verificando cargas completadas...', 'info');
            
            try {
                const shippingService = window.shippingService;
                if (!shippingService) {
                    log('âŒ shippingService nÃ£o disponÃ­vel', 'error');
                    return;
                }

                const loads = await shippingService.getLoads();
                const completed = loads.filter(load => load.status === 'completed');
                
                log(`ğŸ“Š Total de cargas: ${loads.length}`, 'info');
                log(`âœ… Cargas completadas: ${completed.length}`, 'info');

                completed.forEach((load, index) => {
                    log(`ğŸšš Carga ${index + 1}: ${load.loadNumber} - ${load.totalItems} itens - ${load.totalVolume.toFixed(2)}mÂ³`, 'info');
                });

            } catch (error) {
                log(`âŒ Erro ao verificar cargas: ${error.message}`, 'error');
            }
        }

        async function checkProductionOrders() {
            log('ğŸ“‹ Verificando estado das ordens de produÃ§Ã£o...', 'info');
            
            try {
                const productionService = window.productionService;
                if (!productionService) {
                    log('âŒ productionService nÃ£o disponÃ­vel', 'error');
                    return;
                }

                const orders = await productionService.getProductionOrders();
                log(`ğŸ“Š Total de ordens: ${orders.length}`, 'info');

                const byStatus = orders.reduce((acc, order) => {
                    acc[order.status] = (acc[order.status] || 0) + 1;
                    return acc;
                }, {});

                log('ğŸ“Š Por status:', 'info');
                Object.entries(byStatus).forEach(([status, count]) => {
                    log(`   - ${status}: ${count} ordens`, 'info');
                });

                // Verificar linhas shipped
                let shippedLines = 0;
                orders.forEach(order => {
                    order.lines.forEach(line => {
                        if (line.status === 'shipped') {
                            shippedLines++;
                        }
                    });
                });

                log(`ğŸšš Linhas expedidas: ${shippedLines}`, shippedLines > 0 ? 'success' : 'info');

            } catch (error) {
                log(`âŒ Erro ao verificar ordens: ${error.message}`, 'error');
            }
        }

        async function clearShippingData() {
            log('ğŸ§¹ Limpando dados de shipping...', 'warning');
            
            if (!confirm('Tem certeza que quer limpar todos os dados de shipping? Esta aÃ§Ã£o nÃ£o pode ser desfeita.')) {
                log('âŒ OperaÃ§Ã£o cancelada pelo utilizador', 'info');
                return;
            }

            try {
                // Limpar dados relacionados ao shipping
                localStorage.removeItem('factoryControl_shipping');
                
                // Limpar dados de produÃ§Ã£o tambÃ©m se necessÃ¡rio
                const clearProduction = confirm('Quer tambÃ©m limpar dados de produÃ§Ã£o?');
                if (clearProduction) {
                    localStorage.removeItem('factoryControl_production');
                }

                log('âœ… Dados de shipping limpos com sucesso', 'success');
                log('ğŸ”„ Recarregue a pÃ¡gina para ver os efeitos', 'info');

            } catch (error) {
                log(`âŒ Erro ao limpar dados: ${error.message}`, 'error');
            }
        }

        // Inicializar
        log('ğŸš€ Sistema de teste de shipping carregado', 'success');
        log('Clique nos botÃµes acima para testar as correÃ§Ãµes', 'info');
    </script>
</body>
</html>
