<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš¨ Emergency Fix - React useState Error</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        .emergency { background: #dc3545; color: white; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center; }
        .log { background: #fff; padding: 10px; margin: 10px 0; border-radius: 5px; border-left: 5px solid #6c757d; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .info { border-left-color: #17a2b8; background: #d1ecf1; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        button { background: #dc3545; color: white; border: none; padding: 15px 25px; margin: 5px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background: #c82333; }
        .safe-btn { background: #28a745; }
        .safe-btn:hover { background: #218838; }
        .section { background: white; margin: 20px 0; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="emergency">
        <h1>ğŸš¨ EMERGENCY FIX</h1>
        <h2>React useState Returning NULL</h2>
        <p>Este script resolverÃ¡ definitivamente o erro de navegaÃ§Ã£o</p>
    </div>

    <div class="section">
        <h2>ğŸ¯ Problema Identificado</h2>
        <p><strong>Erro:</strong> <code>Cannot read properties of null (reading 'useState')</code></p>
        <p><strong>Causa:</strong> React hooks retornando null devido a dados corrompidos ou import incorreto</p>
        <p><strong>Stack trace aponta para:</strong> SimplePWAInstall component (linha especÃ­fica no bundle)</p>
    </div>

    <div class="section">
        <h2>ğŸš¨ AÃ‡Ã•ES DE EMERGÃŠNCIA</h2>
        <button onclick="emergencyCleanup()">ğŸ§¹ LIMPEZA TOTAL DE EMERGÃŠNCIA</button>
        <button onclick="fixReactIssue()">âš›ï¸ CORRIGIR PROBLEMA REACT</button>
        <button onclick="resetToCleanState()">ğŸ”„ RESET COMPLETO DO SISTEMA</button>
        <button onclick="debugReactState()" class="safe-btn">ğŸ” DEBUG REACT STATE</button>
    </div>

    <div class="section">
        <h2>âœ… TESTE APÃ“S CORREÃ‡ÃƒO</h2>
        <button onclick="testApp()" class="safe-btn">ğŸš€ TESTAR APLICAÃ‡ÃƒO</button>
        <button onclick="goToApp()" class="safe-btn">ğŸ“± IR PARA APP</button>
    </div>
    
    <div id="output"></div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            output.appendChild(div);
            console.log(message);
        }

        function emergencyCleanup() {
            log('ğŸš¨ INICIANDO LIMPEZA TOTAL DE EMERGÃŠNCIA...', 'error');
            
            try {
                // 1. Limpar TODOS os dados do localStorage
                const allKeys = Object.keys(localStorage);
                let factoryKeys = 0;
                let otherKeys = 0;
                
                allKeys.forEach(key => {
                    if (key.startsWith('factoryControl_') || 
                        key.includes('production') || 
                        key.includes('maintenance') || 
                        key.includes('shipping') ||
                        key.includes('operator') ||
                        key.includes('auth')) {
                        localStorage.removeItem(key);
                        factoryKeys++;
                    } else if (key.includes('react') || key.includes('vite') || key.includes('dev')) {
                        localStorage.removeItem(key);
                        otherKeys++;
                    }
                });
                
                log(`ğŸ—‘ï¸ Removidas ${factoryKeys} chaves do FactoryControl`, 'warning');
                log(`ğŸ—‘ï¸ Removidas ${otherKeys} chaves de desenvolvimento`, 'warning');
                
                // 2. Limpar sessionStorage tambÃ©m
                sessionStorage.clear();
                log('ğŸ§¹ SessionStorage limpo', 'warning');
                
                // 3. ForÃ§ar reload do cache do navegador
                if (caches) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                            log(`ğŸ—‘ï¸ Cache removido: ${name}`, 'warning');
                        });
                    });
                }
                
                log('âœ… LIMPEZA TOTAL CONCLUÃDA', 'success');
                log('ğŸ”„ Recarregue a pÃ¡gina para aplicar as mudanÃ§as', 'info');
                
            } catch (error) {
                log(`âŒ Erro na limpeza: ${error.message}`, 'error');
            }
        }

        function fixReactIssue() {
            log('âš›ï¸ CORRIGINDO PROBLEMA ESPECÃFICO DO REACT...', 'info');
            
            try {
                // 1. Verificar se React estÃ¡ disponÃ­vel
                if (typeof React !== 'undefined') {
                    log('âœ… React estÃ¡ disponÃ­vel globalmente', 'success');
                } else {
                    log('âš ï¸ React nÃ£o estÃ¡ disponÃ­vel globalmente', 'warning');
                }
                
                // 2. Limpar qualquer cache especÃ­fico do React
                const reactKeys = Object.keys(localStorage).filter(key => 
                    key.includes('react') || key.includes('hook') || key.includes('state')
                );
                
                reactKeys.forEach(key => {
                    localStorage.removeItem(key);
                    log(`ğŸ—‘ï¸ Removida chave React: ${key}`, 'warning');
                });
                
                // 3. ForÃ§ar reload dos mÃ³dulos
                if (typeof window !== 'undefined' && window.location) {
                    // Adicionar parÃ¢metro para evitar cache
                    const url = new URL(window.location.href);
                    url.searchParams.set('_fix', Date.now().toString());
                    
                    log('ğŸ”„ Preparando reload com cache bypass...', 'info');
                    setTimeout(() => {
                        window.location.href = url.toString();
                    }, 2000);
                }
                
                log('âœ… CorreÃ§Ã£o React aplicada', 'success');
                
            } catch (error) {
                log(`âŒ Erro na correÃ§Ã£o React: ${error.message}`, 'error');
            }
        }

        function resetToCleanState() {
            log('ğŸ”„ RESET COMPLETO DO SISTEMA...', 'warning');
            
            if (!confirm('âš ï¸ ATENÃ‡ÃƒO: Isso irÃ¡ apagar TODOS os dados e resetar o sistema. Tem certeza?')) {
                log('âŒ Reset cancelado pelo usuÃ¡rio', 'info');
                return;
            }
            
            try {
                // 1. Limpar tudo
                localStorage.clear();
                sessionStorage.clear();
                
                // 2. Criar estrutura bÃ¡sica segura
                const safeData = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    productionOrders: [],
                    productSheets: [],
                    chatMessages: [],
                    operatorSessions: [],
                    foamBlocks: [],
                    stockMovements: [],
                    foamTypes: [
                        {
                            id: '1',
                            name: 'Espuma D20',
                            density: 20,
                            hardness: 'Macia',
                            color: 'Branca',
                            specifications: 'Espuma padrÃ£o D20',
                            pricePerM3: 45.00,
                            stockColor: '#f8f9fa'
                        }
                    ]
                };
                
                localStorage.setItem('factoryControl_production', JSON.stringify(safeData));
                
                log('âœ… Sistema resetado para estado limpo e seguro', 'success');
                log('ğŸ“Š Dados bÃ¡sicos criados com proteÃ§Ãµes', 'success');
                log('ğŸ”„ Sistema pronto para uso sem erros', 'success');
                
                // Auto-redirect apÃ³s 3 segundos
                setTimeout(() => {
                    log('ğŸš€ Redirecionando para aplicaÃ§Ã£o...', 'info');
                    window.location.href = 'http://localhost:3000';
                }, 3000);
                
            } catch (error) {
                log(`âŒ Erro no reset: ${error.message}`, 'error');
            }
        }

        function debugReactState() {
            log('ğŸ” DEBUGGING ESTADO DO REACT...', 'info');
            
            try {
                // Verificar ambiente
                log(`ğŸŒ User Agent: ${navigator.userAgent}`, 'info');
                log(`ğŸ”’ Secure Context: ${window.isSecureContext}`, 'info');
                log(`ğŸ“ Location: ${window.location.href}`, 'info');
                
                // Verificar React
                if (typeof React !== 'undefined') {
                    log(`âš›ï¸ React Version: ${React.version || 'Unknown'}`, 'success');
                    
                    if (React.useState) {
                        log('âœ… useState estÃ¡ disponÃ­vel', 'success');
                    } else {
                        log('âŒ useState NÃƒO estÃ¡ disponÃ­vel', 'error');
                    }
                } else {
                    log('âŒ React nÃ£o estÃ¡ disponÃ­vel no escopo global', 'error');
                }
                
                // Verificar localStorage
                const keys = Object.keys(localStorage);
                log(`ğŸ’¾ LocalStorage tem ${keys.length} chaves`, 'info');
                
                const factoryKeys = keys.filter(k => k.startsWith('factoryControl_'));
                log(`ğŸ­ FactoryControl tem ${factoryKeys.length} chaves`, 'info');
                
                factoryKeys.forEach(key => {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        const size = JSON.stringify(data).length;
                        log(`   ğŸ“Š ${key}: ${size} bytes`, 'info');
                    } catch (error) {
                        log(`   âŒ ${key}: dados corrompidos`, 'error');
                    }
                });
                
                log('âœ… Debug concluÃ­do', 'success');
                
            } catch (error) {
                log(`âŒ Erro no debug: ${error.message}`, 'error');
            }
        }

        function testApp() {
            log('ğŸš€ TESTANDO APLICAÃ‡ÃƒO...', 'info');
            
            try {
                // Testar conexÃ£o
                fetch('http://localhost:3000')
                    .then(response => {
                        if (response.ok) {
                            log('âœ… Servidor respondendo normalmente', 'success');
                            log('ğŸŒ Status: ' + response.status, 'success');
                            return response.text();
                        } else {
                            throw new Error('Status: ' + response.status);
                        }
                    })
                    .then(html => {
                        if (html.includes('root')) {
                            log('âœ… HTML contÃ©m elemento root', 'success');
                        }
                        if (html.includes('react')) {
                            log('âœ… React detectado no HTML', 'success');
                        }
                        log('âœ… AplicaÃ§Ã£o parece estar funcionando', 'success');
                    })
                    .catch(error => {
                        log(`âŒ Erro ao testar app: ${error.message}`, 'error');
                    });
                    
            } catch (error) {
                log(`âŒ Erro no teste: ${error.message}`, 'error');
            }
        }

        function goToApp() {
            log('ğŸš€ Redirecionando para aplicaÃ§Ã£o...', 'info');
            window.location.href = 'http://localhost:3000';
        }

        // Monitorar erros
        window.addEventListener('error', (event) => {
            log(`âŒ Erro detectado: ${event.message}`, 'error');
        });

        // Inicializar
        log('ğŸš¨ Sistema de emergÃªncia carregado', 'error');
        log('Use os botÃµes acima para resolver o erro definitivamente', 'warning');
        log('Recomendo comeÃ§ar com "LIMPEZA TOTAL DE EMERGÃŠNCIA"', 'warning');
    </script>
</body>
</html>
