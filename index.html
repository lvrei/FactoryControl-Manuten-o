<!doctype html>
<html lang="pt-PT">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>FactoryControl - GestÃ£o de ManutenÃ§Ã£o</title>

    <!-- PWA Meta Tags -->
    <meta
      name="description"
      content="Sistema completo de gestÃ£o de manutenÃ§Ã£o industrial com checklists DL50"
    />
    <meta name="theme-color" content="#2563eb" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="FactoryControl" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />

    <!-- iOS Icons -->
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="/icons/icon-152x152.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/icons/icon-192x192.png"
    />

    <!-- Favicon -->
    <link rel="icon" href="/favicon.ico" />

    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#2563eb" />
    <meta name="msapplication-TileImage" content="/icons/icon-144x144.png" />

    <!-- Disable zoom on mobile -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
  </head>

  <body>
    <div id="root"></div>

    <script type="module" src="/client/App.tsx"></script>

    <!-- PWA Service Worker Registration -->
    <script>
      // Test Service Worker support first
      console.log("ðŸ” Testing Service Worker support...");
      console.log("ServiceWorker in navigator:", "serviceWorker" in navigator);
      console.log("Navigator:", navigator);
      console.log("Location:", location);

      // Enhanced PWA registration with better mobile support
      if ("serviceWorker" in navigator) {
        const isLocalDev =
          location.hostname === "localhost" ||
          location.hostname === "127.0.0.1";
        if (isLocalDev) {
          console.log("âš ï¸ SW desativado em desenvolvimento local");
        } else {
          window.addEventListener("load", function () {
            navigator.serviceWorker
              .register("/sw.js", { scope: "/" })
              .then(function (registration) {
                console.log("âœ… ServiceWorker registered:", registration.scope);
                registration.addEventListener("updatefound", function () {
                  const newWorker = registration.installing;
                  if (!newWorker) return;
                  newWorker.addEventListener("statechange", function () {
                    if (
                      newWorker.state === "installed" &&
                      navigator.serviceWorker.controller
                    ) {
                      const key = "fc_sw_notified_once";
                      if (!sessionStorage.getItem(key)) {
                        console.log(
                          "ðŸ†• Nova versÃ£o disponÃ­vel. SerÃ¡ aplicada no prÃ³ximo arranque.",
                        );
                        sessionStorage.setItem(key, "1");
                      }
                    }
                  });
                });
              })
              .catch(function (err) {
                console.error("âŒ ServiceWorker registration failed:", err);
              });
          });
        }

        // Handle service worker messages
        navigator.serviceWorker.addEventListener("message", (event) => {
          if (event.data && event.data.type === "UPDATE_AVAILABLE") {
            console.log("ðŸ“± Update available message received");
          }
        });
      }

      // Enhanced PWA capabilities logging
      function checkPWACapabilities() {
        const capabilities = {
          serviceWorker: "serviceWorker" in navigator,
          installPrompt: "BeforeInstallPromptEvent" in window,
          notifications: "Notification" in window,
          camera:
            "mediaDevices" in navigator &&
            "getUserMedia" in navigator.mediaDevices,
          geolocation: "geolocation" in navigator,
          storage: "localStorage" in window,
          standalone: window.matchMedia("(display-mode: standalone)").matches,
          webAppManifest:
            document.querySelector('link[rel="manifest"]') !== null,
          isSecureContext: window.isSecureContext,
          platform: navigator.platform,
          userAgent: navigator.userAgent,
          isOnline: navigator.onLine,
        };

        console.log("ðŸ” PWA Capabilities Check:", capabilities);

        // Store capabilities for debugging
        window.pwaCapabilities = capabilities;

        return capabilities;
      }

      // Check capabilities after DOM loads
      setTimeout(checkPWACapabilities, 500);

      // Enhanced manifest check with retry
      async function checkManifest() {
        try {
          const response = await fetch("/manifest.json", {
            method: "GET",
            cache: "no-cache",
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const manifest = await response.json();
          console.log("âœ… Manifest loaded successfully:", {
            name: manifest.name,
            startUrl: manifest.start_url,
            display: manifest.display,
            icons: manifest.icons?.length || 0,
          });

          // Store manifest for debugging
          window.pwaManifest = manifest;
        } catch (error) {
          console.error("âŒ Manifest failed to load:", error);

          // Retry after 2 seconds
          setTimeout(checkManifest, 2000);
        }
      }

      checkManifest();

      // Listen for online/offline changes
      window.addEventListener("online", () => {
        console.log("ðŸŒ App is now ONLINE");
      });

      window.addEventListener("offline", () => {
        console.log("ðŸ“´ App is now OFFLINE");
      });

      // Enhanced beforeinstallprompt logging
      window.addEventListener("beforeinstallprompt", (e) => {
        console.log("ðŸŽ¯ beforeinstallprompt event fired");
        console.log("Platforms:", e.platforms);

        // Store the event for debugging
        window.pwaInstallPrompt = e;
      });

      // Listen for app installed
      window.addEventListener("appinstalled", () => {
        console.log("ðŸŽ‰ PWA was installed successfully!");
      });

      console.log("ðŸš€ PWA initialization complete");
    </script>
  </body>
</html>
